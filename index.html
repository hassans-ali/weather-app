<script>
  const btn = document.querySelector('.main-fetch');
  const inp = document.querySelector('.inp');
  const cards = document.querySelector('.cards');

  let apiKey = ''; // ðŸ”¹ API key variable

  // ðŸ”¹ Fetch API key once when page loads
  fetch('https://32b3cafc-e3fa-4ed1-a18d-34e7e701d0a6-00-1722rgpwfnxtm.sisko.replit.dev/apikey')
    .then(res => res.json())
    .then(data => {
      apiKey = data.apikey;
    })
    .catch(err => {
      cards.innerHTML = `<h1 style="color:red">Failed to load API key</h1>`;
      console.error('API key fetch error:', err);
    });

  btn.addEventListener('click', (e) => {
    e.preventDefault();
    const city = inp.value.trim();

    if (!city) {
      cards.innerHTML = '<h1 style="color:red">Please enter a city name</h1>';
      return;
    }

    if (!apiKey) {
      cards.innerHTML = '<h1 style="color:red">API key not loaded yet</h1>';
      return;
    }

    fetch(`https://api.openweathermap.org/data/2.5/forecast?q=${city}&appid=${apiKey}&units=metric`)
      .then(res => res.json())
      .then(js => {
        cards.innerHTML = '';

        if (js.cod == '404') {
          cards.innerHTML = '<h1 style="color:red">City not found</h1>';
        } else if (js.cod == '400') {
          cards.innerHTML = '<h1 style="color:red">Empty input</h1>';
        } else {
          for (let i = 0; i < js.list.length; i++) {
            const dateTime = js.list[i].dt_txt;
            cards.innerHTML += `
              <div class="d-flex flex-column col-md-3 m-2" style="border: 2px solid black; border-radius: 20px;">
                <div class="d-flex flex-row justify-content-between">
                  <span>${js.city.name}</span>
                  <span>${dateTime}</span>
                </div>
                <div class="d-flex flex-column text-center">
                  <h1>${js.list[i].main.temp}<sup>o</sup>C</h1>
                  <span>${js.list[i].weather[0].main}</span>
                </div>
                <div class="d-flex flex-row justify-content-between">
                  <div class="d-flex flex-column">
                    <span><img src="https://uxwing.com/wp-content/themes/uxwing/download/weather/wind-icon.png" style="width:20px" alt=""> ${js.list[i].wind.speed}</span>
                    <span><img src="https://cdn-icons-png.flaticon.com/512/2299/2299296.png" style="width:20px" alt=""> ${js.list[i].main.pressure}</span>
                    <span><img src="https://cdn-icons-png.flaticon.com/512/8073/8073854.png" style="width:20px" alt=""> ${js.city.population}</span>
                  </div>
                  <img src="http://openweathermap.org/img/wn/${js.list[i].weather[0].icon}@2x.png" style='width:100px' title='${js.list[i].weather[0].description}' class="card-img-top" alt="">
                </div>
              </div>
            `;
          }
        }
      })
      .catch(err => {
        cards.innerHTML = `<h1 style="color:red">Failed to fetch weather data</h1>`;
        console.error(err);
      });
  });

  const night = document.querySelector('.night');
  night.addEventListener('click', (e) => {
    e.preventDefault();
    const nightImg = night.querySelector('img');
    const body = document.querySelector('body');

    if (nightImg.getAttribute('src').includes('sun-warm-icon')) {
      nightImg.setAttribute('src', 'https://uxwing.com/wp-content/themes/uxwing/download/nature-and-environment/moon-icon.png');
      body.style.backgroundColor = 'grey';
      inp.style.backgroundColor = 'grey';
    } else {
      nightImg.setAttribute('src', 'https://uxwing.com/wp-content/themes/uxwing/download/weather/sun-warm-icon.png');
      body.style.backgroundColor = 'lightblue';
      inp.style.backgroundColor = '';
    }
  });
</script>
